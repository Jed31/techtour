<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City TechTour</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        /* GIỮ NGUYÊN GIAO DIỆN GLASS CŨ */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --glass-bg: rgba(30, 30, 40, 0.5); 
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent-color: #0A84FF;
            --text-main: #ffffff;
            --text-sub: rgba(235, 235, 245, 0.65);
        }
        body { overflow: hidden; font-family: 'Inter', sans-serif; background: #000; color: white; }
        #canvas-container { width: 100vw; height: 100vh; display: block; z-index: 1; }
        
        #ui-layer {
            position: absolute; bottom: 50px; right: 50px;
            display: flex; flex-direction: column; gap: 20px;
            width: fit-content; min-width: 340px; max-width: 420px;
            background: var(--glass-bg);
            backdrop-filter: saturate(180%) blur(50px);
            -webkit-backdrop-filter: saturate(180%) blur(50px);
            border: 1px solid var(--glass-border);
            border-radius: 32px; padding: 32px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.6);
            transform: translateY(30px) scale(0.95); opacity: 0;
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 10;
        }
        #ui-layer.visible { transform: translateY(0) scale(1); opacity: 1; }
        
        #narrator-header { display: flex; align-items: center; gap: 12px; }
        #ai-orb {
            width: 20px; height: 20px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #60a5fa, #2563eb);
            box-shadow: 0 0 15px var(--accent-color);
            animation: breathe 3s infinite ease-in-out;
            flex-shrink: 0;
        }
        @keyframes breathe { 0%, 100% { opacity: 0.8; transform: scale(1); } 50% { opacity: 1; transform: scale(1.15); } }
        #narrator-name { font-size: 0.75rem; font-weight: 700; letter-spacing: 1.5px; color: var(--text-sub); text-transform: uppercase; }
        #dialogue-text { font-size: 1.1rem; line-height: 1.6; color: var(--text-main); font-weight: 500; letter-spacing: -0.01em; }
        #choices-container { display: flex; flex-direction: column; gap: 12px; width: 100%; }
        .choice-btn {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; padding: 18px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            color: var(--text-main); font-size: 0.95rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s ease;
        }
        .choice-btn:hover { background: rgba(255, 255, 255, 0.15); transform: scale(1.02); }
        .choice-btn::after { content: '→'; opacity: 0.4; transition: 0.2s; transform: translateX(-5px); }
        .choice-btn:hover::after { opacity: 1; transform: translateX(0); color: var(--accent-color); }
        #voice-status { font-size: 0.75rem; color: var(--text-sub); text-align: center; margin-top: 5px; opacity: 0.7; }

        /* LOADING */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;
            background: #000; transition: opacity 0.8s;
        }
        #start-tour-btn {
            width: auto; padding: 18px 48px; background: var(--accent-color); color: white; border: none;
            border-radius: 100px; font-weight: 700; cursor: pointer; transition: 0.2s; display: none;
        }
        #start-tour-btn:hover { filter: brightness(1.1); transform: scale(1.03); }
        #loading-msg { color: #888; font-size: 0.9rem; margin-top: 10px; font-family: monospace; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div id="loading-text" style="color:#fff; letter-spacing:4px; font-size:1.2rem; font-weight:bold;">BUILDING 4 CITIES...</div>
        <div id="loading-msg">Initializing...</div>
        <button id="start-tour-btn">START WORLD TOUR</button>
    </div>

    <div id="ui-layer">
        <div id="narrator-header">
            <div id="ai-orb"></div>
            <div id="narrator-name">AI Guide</div>
        </div>
        <div id="dialogue-text">...</div>
        <div id="choices-container"></div>
        <div id="voice-status"></div>
    </div>
    
    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { GLTFLoader } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/GLTFLoader.js';
        import { RGBELoader } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/RGBELoader.js';
        import { DRACOLoader } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/DRACOLoader.js';
        import gsap from 'https://cdn.skypack.dev/gsap@3.10.4';
        import { OrbitControls } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls.js';

        // --- CẤU HÌNH HÀNH TRÌNH 4 THÀNH PHỐ ---
        const tourData = {
            // --- CITY 1 (PACK 1) - TỌA ĐỘ 0 ---
            city1_start: {
                text: "Welcome to District 1: The Origin City. This is where our journey begins.",
                position: { x: 50, y: 30, z: 50 }, lookAt: { x: 0, y: 0, z: 0 }, 
                choices: [ 
                    { label: "Fly to District 2 (Pack 3)", target: "city2_start" }, // Bay sang thành phố 2
                    { label: "Explore Streets", target: "city1_street" }
                ]
            },
            city1_street: {
                text: "We are at the street level of District 1.",
                position: { x: 0, y: 2, z: 10 }, lookAt: { x: 0, y: 2, z: -20 },
                choices: [ { label: "Back to Sky", target: "city1_start" } ]
            },

            // --- CITY 2 (PACK 3) - TỌA ĐỘ 500 ---
            city2_start: {
                text: "Arriving at District 2: The Industrial Hub. Notice the different architecture style.",
                position: { x: 550, y: 30, z: 50 }, lookAt: { x: 500, y: 0, z: 0 },
                choices: [ 
                    { label: "Fly to District 3 (Pack 5)", target: "city3_start" }, // Bay tiếp
                    { label: "Go back to District 1", target: "city1_start" }
                ]
            },

            // --- CITY 3 (PACK 5) - TỌA ĐỘ 1000 ---
            city3_start: {
                text: "Welcome to District 3: The Financial Center. This area is dense with skyscrapers.",
                position: { x: 1050, y: 30, z: 50 }, lookAt: { x: 1000, y: 0, z: 0 },
                choices: [ 
                    { label: "Fly to District 4 (Pack 7)", target: "city4_start" },
                    { label: "Go back to District 2", target: "city2_start" }
                ]
            },

            // --- CITY 4 (PACK 7) - TỌA ĐỘ 1500 ---
            city4_start: {
                text: "Final destination: District 4. The Future Zone.",
                position: { x: 1550, y: 30, z: 50 }, lookAt: { x: 1500, y: 0, z: 0 },
                choices: [ 
                    { label: "Explore District 4", target: "city4_explore" },
                    { label: "Return to Start", target: "city1_start" } // Bay một mạch về đầu
                ]
            },
            city4_explore: {
                text: "Enjoy the view of the Future Zone.",
                position: { x: 1500, y: 5, z: 10 }, lookAt: { x: 1500, y: 5, z: -20 },
                choices: [ { label: "Back to Sky", target: "city4_start" } ]
            }
        };

        // --- HÀM LOAD MODEL TỔNG QUÁT ---
        function loadCityModel(filename, x_offset) {
            gltfLoader.load(filename, (gltf) => {
                const model = gltf.scene;
                // Đặt vị trí X theo tham số truyền vào
                model.position.set(x_offset, 0, 0); 
                model.scale.set(1, 1, 1);
                scene.add(model);
                
                // Lưu animation
                if(gltf.animations.length > 0) {
                    const mixer = new THREE.AnimationMixer(model);
                    gltf.animations.forEach((clip) => mixer.clipAction(clip).play());
                    mixers.push(mixer);
                }
                console.log(`Loaded ${filename} at x=${x_offset}`);
            }, 
            undefined, 
            (error) => console.error(`Error loading ${filename}:`, error));
        }

        // --- SETUP SCENE ---
        const scene = new THREE.Scene();
        // Tầm nhìn cực xa (10000) để thấy hết 4 thành phố
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 10000); 
        camera.position.set(50, 30, 50);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.outputEncoding = THREE.sRGBEncoding;
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // --- LOADERS ---
        const manager = new THREE.LoadingManager();
        manager.onLoad = () => {
            console.log("WORLD COMPLETE");
            document.getElementById('loading-screen').style.opacity = 0;
            setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 1000);
            document.getElementById('ui-layer').classList.add('visible');
            
            // Kích hoạt âm thanh
            window.speechSynthesis.speak(new SpeechSynthesisUtterance("")); 
            animate(); 
            moveTo('city1_start');
        };
        
        // Tính % tải của tổng các file
        manager.onProgress = (url, loaded, total) => {
            const percent = Math.round((loaded / total) * 100);
            document.getElementById('loading-msg').innerText = `Loading Asset ${loaded}/${total} (${percent}%)`;
        };

        const rgbeLoader = new RGBELoader(manager);
        rgbeLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/equirectangular/royal_esplanade_1k.hdr', (texture) => {
            texture.mapping = THREE.EquirectangularReflectionMapping;
            scene.background = texture; scene.environment = texture;
        });

        const dracoLoader = new DRACOLoader();
        dracoLoader.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
        const gltfLoader = new GLTFLoader(manager);
        gltfLoader.setDRACOLoader(dracoLoader);

        // --- ▼▼▼ LOAD 4 THÀNH PHỐ ▼▼▼ ---
        const mixers = []; 
        
        // Cách nhau 500 đơn vị
        loadCityModel('city_pack_1.glb', 0);    // City 1
        loadCityModel('city_pack_3.glb', 500);  // City 2
        loadCityModel('city_pack_5.glb', 1000); // City 3
        loadCityModel('city_pack_7.glb', 1500); // City 4

        // --- UI LOGIC ---
        let currentAudio = null;
        let controlsTarget = new THREE.Vector3(0,0,0);

        function playVoice(text) {
            const statusEl = document.getElementById('voice-status');
            window.speechSynthesis.cancel();
            statusEl.innerText = "Guide Speaking...";
            const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; 
            u.onend = () => statusEl.innerText = "";
            window.speechSynthesis.speak(u);
        }

        function updateUI(key) {
            const data = tourData[key];
            const textEl = document.getElementById('dialogue-text');
            const choicesEl = document.getElementById('choices-container');
            
            textEl.style.opacity = 0; textEl.style.transform = "translateY(5px)";
            setTimeout(() => {
                textEl.innerText = data.text;
                textEl.style.opacity = 1; textEl.style.transform = "translateY(0)";
                textEl.style.transition = "all 0.5s ease";
                playVoice(data.text);
            }, 300);

            choicesEl.innerHTML = '';
            data.choices.forEach(c => {
                const btn = document.createElement('div');
                btn.className = 'choice-btn'; btn.innerText = c.label;
                btn.onclick = () => moveTo(c.target);
                choicesEl.appendChild(btn);
            });
        }

        function moveTo(key) {
            const target = tourData[key];
            
            // Bay Camera
            gsap.to(camera.position, { 
                x: target.position.x, y: target.position.y, z: target.position.z, 
                duration: 4, // Bay chậm hơn chút vì quãng đường xa
                ease: "power2.inOut" 
            });
            
            // Xoay Camera
            gsap.to(controlsTarget, { 
                x: target.lookAt.x, y: target.lookAt.y, z: target.lookAt.z, 
                duration: 4, 
                ease: "power2.inOut", 
                onUpdate: () => {
                    camera.lookAt(controlsTarget);
                    controls.target.copy(controlsTarget);
                } 
            });
            
            updateUI(key);
        }

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            mixers.forEach(mixer => mixer.update(delta));
            controls.update();
            renderer.render(scene, camera);
        }

        window.onresize = () => {
            camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
