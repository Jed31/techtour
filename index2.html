<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionOS City Tour (Draco Support)</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        /* --- 1. CSS GLOBAL --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --glass-bg: rgba(30, 30, 40, 0.5); 
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent-color: #0A84FF;
            --text-main: #ffffff;
            --text-sub: rgba(235, 235, 245, 0.65);
        }

        body { 
            overflow: hidden; font-family: 'Inter', sans-serif; 
            background: #000; color: white; 
        }
        
        #canvas-container { width: 100vw; height: 100vh; display: block; z-index: 1; }

        /* --- 2. VISION OS UI PANEL --- */
        #ui-layer {
            position: absolute; bottom: 50px; right: 50px;
            display: flex; flex-direction: column; gap: 20px;
            width: fit-content; min-width: 320px; max-width: 400px;
            
            background: var(--glass-bg);
            backdrop-filter: saturate(180%) blur(50px);
            -webkit-backdrop-filter: saturate(180%) blur(50px);
            
            border: 1px solid var(--glass-border);
            border-radius: 32px; padding: 32px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.6);
            
            transform: translateY(30px) scale(0.95); opacity: 0;
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 10;
        }
        #ui-layer.visible { transform: translateY(0) scale(1); opacity: 1; }

        /* Header */
        #narrator-header { display: flex; align-items: center; gap: 12px; }
        #ai-orb {
            width: 20px; height: 20px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #60a5fa, #2563eb);
            box-shadow: 0 0 15px var(--accent-color);
            animation: breathe 3s infinite ease-in-out;
            flex-shrink: 0;
        }
        @keyframes breathe { 0%, 100% { opacity: 0.8; transform: scale(1); } 50% { opacity: 1; transform: scale(1.15); } }
        #narrator-name { font-size: 0.75rem; font-weight: 700; letter-spacing: 1.5px; color: var(--text-sub); text-transform: uppercase; }

        /* Content */
        #dialogue-text { font-size: 1.1rem; line-height: 1.6; color: var(--text-main); font-weight: 500; letter-spacing: -0.01em; }
        #choices-container { display: flex; flex-direction: column; gap: 12px; width: 100%; }

        /* Buttons */
        .choice-btn {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; padding: 18px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            color: var(--text-main); font-size: 0.95rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s ease;
        }
        .choice-btn:hover { background: rgba(255, 255, 255, 0.15); transform: scale(1.02); }
        .choice-btn::after { content: '→'; opacity: 0.4; transition: 0.2s; transform: translateX(-5px); }
        .choice-btn:hover::after { opacity: 1; transform: translateX(0); color: var(--accent-color); }

        /* Status */
        #voice-status { font-size: 0.75rem; color: var(--text-sub); text-align: center; margin-top: 5px; opacity: 0.7; }

        /* --- 3. MODAL & LOADING --- */
        #key-modal, #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;
        }
        #key-modal { background: rgba(0,0,0,0.6); backdrop-filter: blur(20px); }
        #loading-screen { background: #000; transition: opacity 0.8s; }

        .modal-glass {
            background: rgba(30,30,40,0.7); border: 1px solid rgba(255,255,255,0.15);
            padding: 40px; border-radius: 30px; width: 360px; text-align: center;
            backdrop-filter: blur(40px); box-shadow: 0 40px 80px rgba(0,0,0,0.6);
        }
        .modal-glass input {
            width: 100%; padding: 14px; margin: 20px 0; background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; text-align: center; outline: none;
        }
        .modal-glass button, #start-tour-btn {
            width: 100%; padding: 16px; background: var(--accent-color); color: white; border: none;
            border-radius: 14px; font-weight: 700; cursor: pointer; transition: 0.2s;
        }
        #start-tour-btn { width: auto; padding: 18px 48px; border-radius: 100px; display: none; }
        #start-tour-btn:hover, .modal-glass button:hover { filter: brightness(1.1); transform: scale(1.03); }
        
        #loading-msg { color: #888; font-size: 0.9rem; margin-top: 10px; font-family: monospace; }
    </style>
</head>
<body>

    <div id="key-modal" style="display: none;">
        <div class="modal-glass">
            <h2 style="margin-bottom:10px;">AI Voice Setup</h2>
            <p style="color:#aaa; font-size:0.9rem;">Paste ElevenLabs API Key</p>
            <input type="password" id="api-key-input" placeholder="sk_...">
            <button id="save-key-btn">Enable & Enter</button>
            <div style="margin-top:20px; font-size:0.85rem; color:#888; cursor:pointer;" onclick="useFreeMode()">Skip (Free Mode)</div>
        </div>
    </div>

    <div id="loading-screen">
        <div id="loading-text" style="color:#fff; letter-spacing:4px; font-size:1.2rem; font-weight:bold;">LOADING CITY...</div>
        <div id="loading-msg">Initializing...</div>
        <button id="start-tour-btn">START TOUR</button>
    </div>

    <div id="ui-layer">
        <div id="narrator-header">
            <div id="ai-orb"></div>
            <div id="narrator-name">AI Guide</div>
        </div>
        <div id="dialogue-text">...</div>
        <div id="choices-container"></div>
        <div id="voice-status"></div>
    </div>
    
    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { GLTFLoader } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/GLTFLoader.js';
        import { RGBELoader } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/RGBELoader.js';
        // QUAN TRỌNG: Import DRACOLoader để đọc file nén
        import { DRACOLoader } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/DRACOLoader.js';
        import gsap from 'https://cdn.skypack.dev/gsap@3.10.4';

        // --- CẤU HÌNH TOUR ---
        const tourData = {
            start: {
                text: "Welcome to the City. I'm your AI guide. Let's explore the urban architecture.",
                position: { x: 50, y: 30, z: 50 }, lookAt: { x: 0, y: 0, z: 0 }, 
                choices: [ { label: "Go to Street Level", target: "street" }, { label: "View Tower", target: "tower" } ]
            },
            street: {
                text: "We are now at street level. Notice the layout of the roads.",
                position: { x: 0, y: 2, z: 10 }, lookAt: { x: 0, y: 2, z: -20 },
                choices: [ { label: "Go to Tower", target: "tower" }, { label: "Back to Overview", target: "start" } ]
            },
            tower: {
                text: "Here is the main skyscraper of the district.",
                position: { x: -20, y: 20, z: -20 }, lookAt: { x: 0, y: 10, z: 0 },
                choices: [ { label: "Return to Street", target: "street" }, { label: "Back to Overview", target: "start" } ]
            }
        };

        const VOICE_ID = "21m00Tcm4TlvDq8ikWAM"; 
        let userApiKey = localStorage.getItem("elevenlabs_key");
        let currentAudio = null;
        let controlsTarget = new THREE.Vector3(0,0,0);

        // --- LOGIC KEY & AUDIO ---
        function checkKey() { if(!userApiKey) document.getElementById('key-modal').style.display = 'flex'; }
        document.getElementById('save-key-btn').addEventListener('click', () => {
            const input = document.getElementById('api-key-input').value.trim();
            if(input.length > 5) { localStorage.setItem("elevenlabs_key", input); userApiKey = input; document.getElementById('key-modal').style.display = 'none'; }
        });
        window.useFreeMode = function() { userApiKey = "FREE"; document.getElementById('key-modal').style.display = 'none'; }

        async function playVoice(text) {
            const statusEl = document.getElementById('voice-status');
            if(currentAudio) { currentAudio.pause(); currentAudio = null; }
            if (userApiKey === "FREE") {
                statusEl.innerText = "System Voice Active"; window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; window.speechSynthesis.speak(u); return;
            }
            statusEl.innerText = "AI Generating...";
            try {
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}`, {
                    method: 'POST', headers: { 'xi-api-key': userApiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text, model_id: "eleven_monolingual_v1" })
                });
                if(!response.ok) {
                    if(response.status === 401) { localStorage.removeItem("elevenlabs_key"); location.reload(); }
                    throw new Error("API Error");
                }
                const blob = await response.blob(); currentAudio = new Audio(URL.createObjectURL(blob));
                statusEl.innerText = "Speaking..."; currentAudio.play(); currentAudio.onended = () => statusEl.innerText = "";
            } catch (e) { console.error(e); statusEl.innerText = "Voice Error"; }
        }

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        // Far clip 2000 để nhìn xa
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 2000); 
        camera.position.set(50, 30, 50);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.outputEncoding = THREE.sRGBEncoding;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Loading Manager
        const manager = new THREE.LoadingManager();
        manager.onLoad = () => {
            console.log("ALL ASSETS LOADED");
            document.getElementById('loading-text').innerText = "READY";
            document.getElementById('loading-msg').style.display = "none";
            document.getElementById('start-tour-btn').style.display = 'block';
        };
        manager.onError = (url) => {
            console.error("Error loading:", url);
            document.getElementById('loading-msg').innerText = "ERROR: Could not load " + url;
            document.getElementById('loading-msg').style.color = "red";
        };

        const rgbeLoader = new RGBELoader(manager);
        rgbeLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/equirectangular/royal_esplanade_1k.hdr', (texture) => {
            texture.mapping = THREE.EquirectangularReflectionMapping;
            scene.background = texture; scene.environment = texture; scene.backgroundBlurriness = 0.5;
        });

        // ▼▼▼ DRACO SETUP (QUAN TRỌNG NHẤT) ▼▼▼
        const dracoLoader = new DRACOLoader();
        // Sử dụng bộ giải mã từ CDN của Google
        dracoLoader.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
        dracoLoader.setDecoderConfig({ type: 'js' }); // Bắt buộc dùng JS decoder cho tương thích tốt nhất

        const gltfLoader = new GLTFLoader(manager);
        gltfLoader.setDRACOLoader(dracoLoader); // Kết nối Draco vào GLTFLoader

        // Tải File City
        gltfLoader.load('city_pack_5.glb', (gltf) => {
            const model = gltf.scene;
            model.scale.set(1, 1, 1); 
            model.position.set(0, 0, 0);
            scene.add(model);
            
            if(gltf.animations.length > 0) {
                mixer = new THREE.AnimationMixer(model);
                gltf.animations.forEach((clip) => mixer.clipAction(clip).play());
            }
        }, 
        // Loading Progress
        (xhr) => { 
            if (xhr.lengthComputable) {
                const percent = Math.round((xhr.loaded / xhr.total) * 100);
                document.getElementById('loading-msg').innerText = `Downloading Model: ${percent}%`;
            }
        });

        // --- UPDATE UI & ANIMATION ---
        function updateUI(key) {
            const data = tourData[key];
            const textEl = document.getElementById('dialogue-text');
            const choicesEl = document.getElementById('choices-container');
            
            textEl.style.opacity = 0; textEl.style.transform = "translateY(5px)";
            setTimeout(() => {
                textEl.innerText = data.text;
                textEl.style.opacity = 1; textEl.style.transform = "translateY(0)";
                textEl.style.transition = "all 0.5s ease";
                playVoice(data.text);
            }, 300);

            choicesEl.innerHTML = '';
            data.choices.forEach(c => {
                const btn = document.createElement('div');
                btn.className = 'choice-btn'; btn.innerText = c.label;
                btn.onclick = () => moveTo(c.target);
                choicesEl.appendChild(btn);
            });
        }

        function moveTo(key) {
            const target = tourData[key];
            gsap.to(camera.position, { x: target.position.x, y: target.position.y, z: target.position.z, duration: 2.5, ease: "power3.inOut" });
            gsap.to(controlsTarget, { x: target.lookAt.x, y: target.lookAt.y, z: target.lookAt.z, duration: 2.5, ease: "power3.inOut", onUpdate: () => camera.lookAt(controlsTarget) });
            updateUI(key);
        }

        let mixer; const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            if(mixer) mixer.update(clock.getDelta());
            camera.lookAt(controlsTarget);
            renderer.render(scene, camera);
        }

        checkKey();
        document.getElementById('start-tour-btn').onclick = () => {
            document.getElementById('loading-screen').style.opacity = 0;
            setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 1000);
            document.getElementById('ui-layer').classList.add('visible');
            animate(); moveTo('start');
        };

        window.onresize = () => {
            camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>